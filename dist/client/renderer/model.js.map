{"version":3,"sources":["model.js"],"names":["Vector3","Vector2","AnimationMixer","AnimationClip","TextGeometry","Font","MeshBasicMaterial","Mesh","Color","GLTFLoader","gridToWorld","WORLD_SCALE","WORLD_SCALE_V","Game","distanceTo","droidJSON","font","Model","constructor","src","scene","x","y","fullScene","pos","setWorldPos","loader","load","modelLoaded","bind","modelLoadProgress","modelLoadError","setPos","copy","mesh","position","updateMatrix","render","time","model","modelLoadedQueue","length","forEach","onModelLoaded","fn","push","children","layer","layers","set","scale","add","xhr","err","console","error","GridSquare","gridPos","state","Instance","selected","selectedCharacter","col","Colors","default","renderer","blockInput","material","color","start","dist","standingOnUs","characterGrid","turnStage","movement","walkable","attackRange","team","attackable","hovered","clone","multiplyScalar","enableCoordinates","coordinates","text","size","height","computeBoundingBox","centerOffsetX","boundingBox","max","min","centerOffsetZ","z","textMesh","rotation","Math","PI","originalColor","floor","random","highlighted","AnimatedModel","mixer","lastDraw","update","playAnimation","anim","stopAllAction","clip","findByName","animations","action","clipAction","play","animate","SquareHighlighter","lastPos","shouldShow","visible","square","CharacterModel","character","modelName","lastCharacterPos","targetPos","movementQueue","movementSpeed","hp","shouldRemove","face","target","atan2","wantsTargetYaw","equals","shift","startingPos","movementStart","yawStart","startingYaw","targetYaw","isAnimating","elapsed","toMove","sub","toRotate","rot"],"mappings":"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","sourcesContent":["import {\n  Vector3,\n  Vector2,\n  AnimationMixer,\n  AnimationClip,\n  TextGeometry,\n  Font,\n  MeshBasicMaterial,\n  Mesh,\n  Color,\n} from \"three\"\n\nimport { GLTFLoader } from \"three/examples/jsm/loaders/GLTFLoader.js\"\nimport { gridToWorld, WORLD_SCALE, WORLD_SCALE_V } from \"./3dutils\"\nimport Game from \"../../shared/game\"\nimport { distanceTo } from \"../../shared/gridutils\"\n\nimport droidJSON from \"three/examples/fonts/droid/droid_sans_regular.typeface.json\"\nconst font = new Font(droidJSON)\n\nexport class Model {\n  constructor(src, scene, x, y, fullScene = false) {\n    this.pos = new Vector3()\n    this.setWorldPos(x, y)\n    this.src = src\n    this.scene = scene\n    this.fullScene = fullScene\n\n    this.loader = new GLTFLoader()\n\n    this.loader.load(\n      \"/3d/\" + src,\n      this.modelLoaded.bind(this),\n      this.modelLoadProgress.bind(this),\n      this.modelLoadError.bind(this)\n    )\n  }\n\n  setWorldPos(x, y) {\n    this.setPos(gridToWorld(x, y))\n  }\n\n  setPos(pos) {\n    this.pos.copy(pos)\n    if (this.mesh) {\n      this.mesh.position.copy(this.pos)\n      this.mesh.updateMatrix()\n    }\n  }\n\n  modelLoadedQueue = []\n  render(time) {\n    if (this.model && this.modelLoadedQueue.length > 0) {\n      this.modelLoadedQueue.forEach((x) => x())\n      this.modelLoadedQueue = []\n    }\n  }\n\n  onModelLoaded(fn) {\n    if (this.model) {\n      fn()\n    } else {\n      this.modelLoadedQueue.push(fn)\n    }\n  }\n\n  modelLoaded(model) {\n    this.model = model\n\n    if (this.fullScene) {\n      this.mesh = model.scene\n    } else {\n      this.mesh = model.scene.children[0]\n    }\n\n    if (this.layer) {\n      this.mesh.layers.set(this.layer)\n    }\n\n    model.model = this\n\n    this.mesh.model = this\n    this.mesh.scale.copy(WORLD_SCALE_V)\n\n    this.scene.add(this.mesh)\n    this.mesh.position.copy(this.pos)\n  }\n\n  modelLoadProgress(xhr) {\n    // console.log(\"Model\", this.src, (xhr.loaded / xhr.total) * 100 + \"% loaded\")\n  }\n\n  modelLoadError(err) {\n    console.error(\"Model couldn't load\", this.src, err)\n  }\n}\n\nexport class GridSquare extends Model {\n  constructor(scene, x, y) {\n    super(\"Floor_Modular.glb\", scene, x, y)\n    this.gridPos = { x, y }\n    this.setWorldPos(x, y)\n  }\n\n  layer = 1\n\n  static Colors = {\n    default: new Color(0.181, 0.181, 0.181),\n    walkable: new Color(0.044, 0.328, 0.638),\n    highlighted: new Color(0.348, 0.348, 0.348),\n    attackRange: new Color(0.147, 0, 0),\n    attackable: new Color(0.421, 0, 0),\n  }\n\n  setPos(pos) {\n    if (this.gridPos) {\n      pos.y = -(((this.gridPos.y % 2) + (this.gridPos.x % 2)) % 2) * 0.03\n    }\n    super.setPos(pos)\n  }\n\n  modelLoaded(model) {\n    super.modelLoaded(model)\n  }\n\n  render(time) {\n    const state = Game.Instance.state\n    const selected = state.selectedCharacter\n\n    let col = GridSquare.Colors.default\n    if (Game.Instance.renderer.blockInput) {\n      this.mesh.material.color.set(col)\n      return\n    }\n\n    if (selected) {\n      const start = selected.pos\n      const dist = distanceTo(start, this.gridPos)\n      const standingOnUs = Game.Instance.characterGrid[this.gridPos.y][this.gridPos.x]\n\n      if (\n        state.turnStage == \"Moving\" &&\n        dist <= selected.movement &&\n        (!standingOnUs || standingOnUs != selected)\n      ) {\n        col = GridSquare.Colors.walkable\n      } else if (state.turnStage == \"Attacking\" && dist <= selected.attackRange) {\n        if (standingOnUs) {\n          if (standingOnUs.team !== selected.team) {\n            col = GridSquare.Colors.attackable\n          }\n        } else {\n          col = GridSquare.Colors.attackRange\n        }\n      }\n    }\n\n    const hovered = Game.Instance.state.hovered\n    if (hovered && hovered.x == this.gridPos.x && hovered.y == this.gridPos.y) {\n      col = col.clone().multiplyScalar(1.35)\n    }\n    this.mesh.material.color.set(col)\n  }\n\n  enableCoordinates() {\n    if (!this.coordinates) {\n      const text = new TextGeometry(`(${this.gridPos.x}, ${this.gridPos.y})`, {\n        font,\n        size: WORLD_SCALE / 3,\n        height: 0.1,\n      })\n\n      text.computeBoundingBox()\n\n      const centerOffsetX = -0.5 * (text.boundingBox.max.x - text.boundingBox.min.x)\n\n      const centerOffsetZ = -0.5 * (text.boundingBox.max.z - text.boundingBox.min.z)\n\n      const textMesh = new Mesh(text, new MeshBasicMaterial({ color: 0xffffff }))\n\n      textMesh.position.x = this.pos.x + centerOffsetX\n      textMesh.position.y = this.pos.y + 0.5\n      textMesh.position.z = this.pos.z + centerOffsetZ\n\n      // textMesh.rotation.x = Math.Pi\n      textMesh.rotation.x = -Math.PI / 2\n\n      this.coordinates = textMesh\n      this.scene.add(textMesh)\n    }\n  }\n\n  modelLoaded(model) {\n    super.modelLoaded(model)\n    this.originalColor = this.mesh.material.color\n    this.mesh.rotation.set(0, ((Math.floor(Math.random() * 4) * 90) / 360) * Math.PI * 2, 0)\n  }\n}\n\nexport class AnimatedModel extends Model {\n  constructor(src, scene, x, y) {\n    super(src, scene, x, y)\n  }\n\n  modelLoaded(model) {\n    super.modelLoaded(model)\n    this.mixer = new AnimationMixer(this.mesh)\n  }\n\n  lastDraw = 0\n  render(time) {\n    super.render(time)\n    if (this.lastDraw == 0) {\n      this.lastDraw = time\n    }\n\n    this.mixer.update((time - this.lastDraw) / 1000)\n    this.lastDraw = time\n  }\n\n  playAnimation(anim) {\n    this.lastDraw = 0\n    this.mixer.stopAllAction()\n\n    const clip = AnimationClip.findByName(this.model.animations, anim)\n    this.action = this.mixer.clipAction(clip)\n    this.action.play()\n  }\n\n  animate(time) {\n    return false\n  }\n}\n\nexport class SquareHighlighter extends AnimatedModel {\n  constructor(scene) {\n    super(\"Swoosh.glb\", scene, 0, 0)\n    this.lastPos = null\n    this.shouldShow = false\n  }\n\n  modelLoaded(model) {\n    super.modelLoaded(model)\n    this.mesh.visible = false\n  }\n\n  render(time) {\n    super.render(time)\n\n    const square = Game.Instance.state.selectedCharacter?.pos\n    if (square != this.lastPos) {\n      this.playAnimation(\"Swoosh\")\n      this.lastPos = square\n      if (square) {\n        this.setWorldPos(square.x, square.y)\n        this.shouldShow = true\n      } else {\n        this.shouldShow = false\n      }\n    }\n\n    this.mesh.visible = this.shouldShow && !Game.Instance.renderer.blockInput\n  }\n}\n\nexport class CharacterModel extends AnimatedModel {\n  constructor(character, scene) {\n    super(character.modelName, scene, 0, 0)\n    this.character = character\n    character.model = this\n\n    this.lastCharacterPos = new Vector2(0, 0)\n    this.targetPos = null\n\n    this.movementQueue = []\n\n    this.movementSpeed = 1\n  }\n\n  modelLoaded(model) {\n    super.modelLoaded(model)\n    this.playAnimation(\"Idle\")\n    if (this.character.pos.y > 7) {\n      this.mesh.rotation.set(0, Math.PI, 0)\n    }\n\n    this.setPos(gridToWorld(this.character.x, this.character.y))\n    this.lastCharacterPos = this.character.pos.clone()\n  }\n\n  render(time) {\n    super.render(time)\n\n    if (this.character.hp < 0) {\n      // AND NOT IS PLAYING DYING ANIMATION\n      this.shouldRemove = true\n    }\n  }\n\n  face(square) {\n    let target = Math.atan2(square.x - this.pos.x, -square.y + this.pos.y)\n    if (target - this.mesh.rotation > Math.PI) {\n      target -= Math.PI\n    }\n\n    this.wantsTargetYaw = target\n  }\n\n  animate(time) {\n    super.animate(time)\n\n    if (!this.character.pos.equals(this.lastCharacterPos)) {\n      this.lastCharacterPos = this.character.pos.clone()\n      this.movementQueue = [this.character.pos.clone()]\n      // Replace with character.calculatePath\n    }\n\n    if (!this.targetPos && this.movementQueue.length) {\n      const pos = this.movementQueue.shift()\n      this.targetPos = gridToWorld(pos.x, pos.y)\n      this.startingPos = this.pos.clone()\n      this.movementStart = time\n      this.face(pos.x, pos.y)\n    }\n\n    if (this.wantsTargetYaw) {\n      this.wantsTargetYaw = null\n\n      this.yawStart = time\n      this.startingYaw = this.mesh.rotation.y\n      this.targetYaw = this.wantsTargetYaw\n    }\n\n    let isAnimating = false\n    if (this.targetPos) {\n      const elapsed = Math.min(1, (time - this.movementStart) / 1000 / this.movementSpeed)\n      const toMove = this.targetPos.clone().sub(this.startingPos.clone()).multiplyScalar(elapsed)\n      this.setPos(toMove.add(this.startingPos))\n\n      if (this.pos.equals(this.targetPos)) {\n        this.targetPos = null\n      }\n\n      isAnimating = true\n    }\n\n    if (this.targetYaw) {\n      const elapsed = Math.min(1, (time - this.yawStart) / 1000 / this.movementSpeed)\n      const toRotate = (this.targetYaw - this.startingYaw) * elapsed\n\n      const rot = this.mesh.rotation\n      this.mesh.rotation.set(rot.x, toRotate, rot.z)\n\n      if (this.targetYaw == rot.y) {\n        this.targetYaw = null\n      }\n\n      isAnimating = true\n    }\n\n    return isAnimating\n  }\n}\n"]}