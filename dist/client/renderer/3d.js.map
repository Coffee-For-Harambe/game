{"version":3,"sources":["3d.js"],"names":["THREE","OrbitControls","RGBELoader","GLTFLoader","CSS3DRenderer","inspect","stopInspecting","Game","Model","AnimatedModel","GridSquare","SquareHighlighter","CharacterModel","gridToWorld","WORLD_SCALE","buildGrid","window","Renderer","constructor","game","Raycaster","renderer","canvas","document","getElementById","debug","scene","setupScene","camera","setupCamera","setupRenderer","setupHDR","setupGrid","setupControls","addEventListener","onWindowResize","bind","onMouseDown","onMouseMoved","onMouseUp","ring","scenery","onModelLoaded","x","mesh","frustumCulled","fadable","getObjectByName","update","redraw","render","time","lastFrame","frameInterval","DEBUGGING","innerHTML","state","turnStage","selectedCharacter","debugStr","teamsTurn","teams","characters","map","c","join","toRemove","Instance","hp","resetTurnState","blockInput","traverse","obj","model","isAnimating","animate","shouldRemove","push","childRemove","child","layers","set","remove","dir1","controls","target","clone","sub","position","normalize","pos","Vector3","material","transparent","getWorldPosition","opacity","Math","pow","dot","cssrenderer","requestAnimationFrame","forEach","team","character","Scene","PerspectiveCamera","innerWidth","innerHeight","enable","domElement","style","top","left","bottom","right","pointerEvents","id","body","appendChild","setSize","renderSettings","antialias","WebGLRenderer","setPixelRatio","devicePixelRatio","physicallyCorrectLights","toneMapping","ACESFilmicToneMapping","toneMappingExposure","outputEncoding","sRGBEncoding","pmremGenerator","PMREMGenerator","compileEquirectangularShader","setDataType","UnsignedByteType","load","texture","envMap","fromEquirectangular","magFilter","LinearFilter","needsUpdate","background","environment","center","grid","linearGrid","y","square","enableCoordinates","aspect","updateProjectionMatrix","e","hoverTimerID","clearTimeout","setTimeout","updateHover","mouse","Vector2","clientX","clientY","raycaster","setFromCamera","intersects","intersectObjects","children","i","length","object","gridPos","hovered","hasCharacter","characterGrid","classList","toggle","squareClicked"],"mappings":"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","sourcesContent":["import * as THREE from \"three\"\nimport { OrbitControls } from \"three/examples/jsm/controls/OrbitControls.js\"\nimport { RGBELoader } from \"three/examples/jsm/loaders/RGBELoader.js\"\nimport { GLTFLoader } from \"three/examples/jsm/loaders/GLTFLoader.js\"\nimport { CSS3DRenderer } from \"three/examples/jsm/renderers/CSS3DRenderer.js\"\n\nimport { inspect, stopInspecting } from \"../debugutils\"\n\nimport Game from \"../../shared/game\"\nimport { Model, AnimatedModel, GridSquare, SquareHighlighter, CharacterModel } from \"./model\"\n\nimport { gridToWorld, WORLD_SCALE } from \"./3dutils\"\n\nimport { buildGrid } from \"../../shared/gridutils\"\n\nwindow.THREE = THREE\n\nexport default class Renderer {\n  constructor(game) {\n    this.game = game\n    game.renderer = this\n\n    this.canvas = document.getElementById(\"canvas\")\n    this.debug = document.getElementById(\"debug\")\n\n    this.scene = this.setupScene()\n\n    this.camera = this.setupCamera()\n\n    this.setupRenderer()\n    this.setupHDR()\n\n    this.setupGrid()\n    this.setupControls()\n\n    window.addEventListener(\"resize\", this.onWindowResize.bind(this))\n\n    canvas.addEventListener(\"pointerdown\", this.onMouseDown.bind(this), false)\n    canvas.addEventListener(\"pointermove\", this.onMouseMoved.bind(this), false)\n    canvas.addEventListener(\"pointerup\", this.onMouseUp.bind(this), false)\n\n    this.ring = new SquareHighlighter(this.scene)\n\n    this.scenery = new Model(\"Scene.glb\", this.scene, 0, 0, true)\n    this.scenery.onModelLoaded((x) => {\n      this.scenery.mesh.frustumCulled = false\n      this.scenery.fadable = this.scenery.mesh.getObjectByName(\"FadableDecor\")\n    })\n    game.update()\n    this.redraw()\n  }\n\n  lastFrame = 0\n  frameInterval = 1000 / 30\n  render(time) {\n    this.redraw()\n\n    if (time - this.lastFrame < this.frameInterval) {\n      return\n    }\n\n    this.lastFrame = time\n\n    if (window.DEBUGGING) {\n      this.debug.innerHTML = `\n      <strong>GAME STATE:</strong>\n        <div style=\"padding-left: 1rem\">\n          turnStage: ${this.game.state.turnStage}<br/>\n          selectedCharacter: ${\n            this.game.state.selectedCharacter\n              ? this.game.state.selectedCharacter.debugStr()\n              : \"null\"\n          }<br/>\n          teamsTurn: ${this.game.state.teamsTurn}<br/>\n        </div>\n      <strong>TEAM1:</strong>\n        <div style=\"padding-left: 1rem\">\n          ${this.game.teams[0].characters.map((c) => c.debugStr()).join(\"<br />\")}\n        </div>\n      <strong>TEAM2:</strong>\n        <div style=\"padding-left: 1rem\">\n          ${this.game.teams[1].characters.map((c) => c.debugStr()).join(\"<br />\")}\n        </div>\n    `\n    }\n\n    const toRemove = []\n\n    if (Game.Instance.state.selectedCharacter) {\n      if (Game.Instance.state.selectedCharacter.hp <= 0) {\n        Game.Instance.resetTurnState()\n      }\n    }\n\n    let blockInput = false\n    this.scene.traverse((obj) => {\n      if (obj.model instanceof AnimatedModel) {\n        const isAnimating = obj.model.animate(time)\n        if (isAnimating) {\n          blockInput = true\n        }\n      }\n    })\n\n    // Traverse Scene twice to first determine blockInput and _then_ update\n    this.scene.traverse((obj) => {\n      if (obj.model instanceof Model) {\n        obj.model.render(time)\n\n        if (obj.model.shouldRemove) {\n          toRemove.push(obj)\n        }\n      }\n    })\n\n    this.blockInput = blockInput\n\n    for (let obj of toRemove) {\n      const childRemove = []\n      obj.traverse((child) => {\n        obj.layers.set(0)\n        child.layers.set(0)\n        childRemove.push(child)\n      })\n\n      for (let child of childRemove) {\n        obj.remove(child)\n      }\n\n      this.scene.remove(obj)\n\n      this.game.update()\n    }\n\n    const dir1 = this.controls.target.clone().sub(this.camera.position.clone()).normalize()\n\n    // TODO: Don't fade on elevated Y axis difference unless it also occludes\n    const pos = new THREE.Vector3()\n    if (this.scenery.fadable) {\n      this.scenery.fadable.traverse((obj) => {\n        if (obj.material) {\n          obj.material.transparent = true\n          obj.getWorldPosition(pos)\n          obj.material.opacity =\n            1 - Math.pow(this.controls.target.clone().sub(pos.clone()).normalize().dot(dir1), 3)\n        }\n      })\n    }\n\n    this.renderer.render(this.scene, this.camera)\n    this.cssrenderer.render(this.scene, this.camera)\n    this.controls.update()\n  }\n\n  redraw() {\n    requestAnimationFrame(this.render.bind(this))\n  }\n\n  update() {\n    this.game.teams.forEach((team) => {\n      team.characters.forEach((character) => {\n        if (!character.model) {\n          character.model = new CharacterModel(character, this.scene)\n        }\n      })\n    })\n  }\n\n  setupScene() {\n    const scene = new THREE.Scene()\n\n    return scene\n  }\n\n  setupCamera() {\n    // Two different types of camera are setup.\n    // const camera = new THREE.OrthographicCamera(-10, 10, 4, -4, 0.1, 1000)\n    const camera = new THREE.PerspectiveCamera(\n      16, // FOV\n      window.innerWidth / window.innerHeight, // Aspect Ratio\n\n      1, // zNear\n      16000 // zFar\n    )\n\n    camera.position.set(807, 889, 912)\n    camera.layers.enable(1)\n    camera.layers.enable(2)\n\n    return camera\n  }\n\n  setupRenderer() {\n    const cssrenderer = new CSS3DRenderer()\n    this.cssrenderer = cssrenderer\n\n    cssrenderer.domElement.style.position = \"fixed\"\n    cssrenderer.domElement.style.top = 0\n    cssrenderer.domElement.style.left = 0\n    cssrenderer.domElement.style.bottom = 0\n    cssrenderer.domElement.style.right = 0\n    cssrenderer.domElement.style.pointerEvents = \"none\"\n    cssrenderer.domElement.id = \"cssrenderer\"\n    document.body.appendChild(cssrenderer.domElement)\n    cssrenderer.setSize(window.innerWidth, window.innerHeight)\n\n    const renderSettings = {\n      canvas: this.canvas,\n      antialias: true,\n    }\n\n    const renderer = new THREE.WebGLRenderer(renderSettings)\n    this.renderer = renderer\n\n    renderer.setPixelRatio(window.devicePixelRatio)\n    renderer.setSize(window.innerWidth, window.innerHeight)\n\n    // renderer.shadowMap.enabled = true\n    // renderer.shadowMap.type = THREE.PCFSoftShadowMap\n\n    renderer.physicallyCorrectLights = true\n    renderer.toneMapping = THREE.ACESFilmicToneMapping\n    // renderer.toneMapping = THREE.LinearToneMappina\n    renderer.toneMappingExposure = 1\n    // renderer.outputEncoding = THREE.LinearEncoding\n    renderer.outputEncoding = THREE.sRGBEncoding\n  }\n\n  setupHDR() {\n    const pmremGenerator = new THREE.PMREMGenerator(this.renderer)\n    pmremGenerator.compileEquirectangularShader()\n    // pmremGenerator.compileCubemapShader()\n\n    new RGBELoader()\n      .setDataType(THREE.UnsignedByteType)\n      .load(\"/images/lilienstein_1k.hdr\", (texture) => {\n        const envMap = pmremGenerator.fromEquirectangular(texture).texture\n\n        texture.magFilter = THREE.LinearFilter\n        texture.needsUpdate = true\n\n        this.scene.background = envMap\n        this.scene.environment = envMap\n      })\n  }\n\n  setupControls() {\n    const controls = new OrbitControls(this.camera, this.renderer.domElement)\n    controls.update()\n\n    const center = gridToWorld(15 / 2, 15 / 2)\n    controls.target = center\n\n    this.controls = controls\n  }\n\n  setupGrid() {\n    this.grid = buildGrid()\n    this.linearGrid = []\n\n    for (let y = 0; y < 16; y++) {\n      for (let x = 0; x < 16; x++) {\n        const square = new GridSquare(this.scene, x, y)\n        this.grid[y][x] = square\n        this.linearGrid.push(square)\n        square.enableCoordinates()\n      }\n    }\n  }\n\n  onWindowResize() {\n    this.camera.aspect = window.innerWidth / window.innerHeight\n    this.camera.updateProjectionMatrix()\n\n    this.cssrenderer.setSize(window.innerWidth, window.innerHeight)\n    this.renderer.setSize(window.innerWidth, window.innerHeight)\n  }\n\n  raycaster = new THREE.Raycaster()\n  hoverTimerID = null\n  onMouseMoved(e) {\n    if (this.hoverTimerID) {\n      window.clearTimeout(this.hoverTimerID)\n    }\n    this.hoverTimerID = setTimeout(() => {\n      this.hoverTimerID = null\n      this.updateHover(e)\n    }, 60)\n  }\n\n  updateHover(e) {\n    this.mouse = null\n\n    const mouse = new THREE.Vector2()\n    mouse.x = (e.clientX / window.innerWidth) * 2 - 1\n    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1\n\n    this.raycaster.layers.set(1)\n\n    this.raycaster.setFromCamera(mouse, this.camera)\n\n    // calculate objects intersecting the picking ray\n    const intersects = this.raycaster.intersectObjects(this.scene.children)\n\n    for (let i = 0; i < intersects.length; i++) {\n      const pos = intersects[i].object?.model?.gridPos\n      if (pos) {\n        this.game.state.hovered = { x: pos.x, y: pos.y }\n        const hasCharacter = this.game.characterGrid[pos.y][pos.x]\n        this.canvas.classList.toggle(\"cursor-pointer\", hasCharacter)\n        return\n      }\n    }\n\n    this.game.state.hovered = null\n  }\n\n  onMouseDown(e) {\n    if (this.blockInput) {\n      return\n    }\n\n    this.updateHover(e)\n\n    this.mouse = new THREE.Vector2()\n    this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1\n    this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1\n  }\n\n  onMouseUp(e) {\n    if (!this.mouse || this.blockInput) {\n      return\n    }\n\n    this.updateHover(e)\n\n    this.game.squareClicked(this.game.state.hovered)\n    inspect(this.game.state.selectedCharacter)\n  }\n}\n"]}